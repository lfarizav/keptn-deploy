---
# KeptnMetric for available CPU cores
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: cluster-available-cpus
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "sum(kube_node_status_capacity{resource='cpu'})"
  fetchIntervalSeconds: 60

---
# KeptnMetric for available memory in GB
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: cluster-available-memory-gb
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "sum(kube_node_status_capacity{resource='memory'}) / 1024 / 1024 / 1024"
  fetchIntervalSeconds: 60

---
# KeptnMetric for ready nodes count
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: cluster-ready-nodes
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "count(kube_node_status_condition{condition='Ready',status='true'})"
  fetchIntervalSeconds: 30

---
# KeptnMetric for MongoDB readiness
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: mongodb-ready
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "kube_pod_status_ready{namespace='k8s-open5gs',pod=~'.*mongodb.*',condition='true'}"
  fetchIntervalSeconds: 10

---
# KeptnMetric for NRF readiness
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: nrf-ready
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "kube_pod_status_ready{namespace='k8s-open5gs',pod=~'.*nrf.*',condition='true'}"
  fetchIntervalSeconds: 10

---
# Post-deployment metrics
# KeptnMetric for running pods count
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: open5gs-pods-running
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "count(kube_pod_status_phase{namespace='k8s-open5gs',phase='Running'})"
  fetchIntervalSeconds: 10

---
# KeptnMetric for failed pods count
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: open5gs-pods-failed
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "count(kube_pod_status_phase{namespace='k8s-open5gs',phase='Failed'}) or vector(0)"
  fetchIntervalSeconds: 10

---
# KeptnMetric for core network functions ready
apiVersion: metrics.keptn.sh/v1
kind: KeptnMetric
metadata:
  name: core-nfs-ready
  namespace: keptn-system
spec:
  provider:
    name: prometheus
  query: "count(kube_pod_status_ready{namespace='k8s-open5gs',pod=~'.*(nrf|smf|amf|upf).*',condition='true'})"
  fetchIntervalSeconds: 10
