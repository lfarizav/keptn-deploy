---
# This Keptn task waits for the subscriber-loader Job to complete
# The actual loading is done by a regular Job in k8s-open5gs chart
apiVersion: lifecycle.keptn.sh/v1
kind: KeptnTaskDefinition
metadata:
  name: subscriber-loader
  namespace: keptn-system
spec:
  container:
    name: subscriber-loader
    image: bitnami/kubectl:latest
    command:
      - /bin/bash
      - -c
      - |
        #!/bin/bash
        set -e
        
        echo "=========================================="
        echo "Keptn Pre-Deployment: Subscriber Loader"
        echo "=========================================="
        echo ""
        
        NAMESPACE="k8s-open5gs"
        MAX_WAIT=300  # 5 minutes
        
        echo "Waiting for subscriber loader Job to complete..."
        echo "Looking for Job with label: app=load-subscribers"
        echo "Namespace: $NAMESPACE"
        echo ""
        
        # Wait for Job to exist (find by label since name includes hash)
        echo "Checking if Job exists..."
        attempt=0
        until JOB_NAME=$(kubectl get jobs -n $NAMESPACE -l app=load-subscribers -o jsonpath='{.items[0].metadata.name}' 2>/dev/null) && [ -n "$JOB_NAME" ]; do
          attempt=$((attempt + 1))
          if [ $attempt -gt 30 ]; then
            echo "✗ Job with label app=load-subscribers not found after 30 attempts"
            echo "Available jobs:"
            kubectl get jobs -n $NAMESPACE
            exit 1
          fi
          echo "  Attempt $attempt - Job not found yet, retrying in 2s..."
          sleep 2
        done
        echo "✓ Job found: $JOB_NAME"
        echo ""
        
        # Wait for Job to complete
        echo "Waiting for Job to complete (max ${MAX_WAIT}s)..."
        if kubectl wait --for=condition=complete --timeout=${MAX_WAIT}s job/$JOB_NAME -n $NAMESPACE; then
          echo "✓ Subscriber loader Job completed successfully"
          
          # Verify subscribers were loaded
          echo ""
          echo "Checking MongoDB for loaded subscribers..."
          
          # Get MongoDB pod
          MONGO_POD=$(kubectl get pod -n $NAMESPACE -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$MONGO_POD" ]; then
            echo "MongoDB pod: $MONGO_POD"
            
            # Check subscriber count
            SUBSCRIBER_COUNT=$(kubectl exec -n $NAMESPACE $MONGO_POD -- mongosh open5gs --quiet --eval "db.subscribers.countDocuments({})" 2>/dev/null || echo "0")
            echo "Subscribers in database: $SUBSCRIBER_COUNT"
            
            if [ "$SUBSCRIBER_COUNT" -gt 0 ]; then
              echo "✓ Subscribers loaded successfully"
            else
              echo "⚠ Warning: No subscribers found in database"
            fi
          else
            echo "⚠ Warning: Could not find MongoDB pod to verify"
          fi
          
          echo ""
          echo "✓ Subscriber loader task COMPLETE"
          exit 0
        else
          echo "✗ Job did not complete within ${MAX_WAIT}s"
          echo ""
          echo "Job status:"
          kubectl get job -n $NAMESPACE $JOB_NAME -o yaml
          echo ""
          echo "Job pods:"
          kubectl get pods -n $NAMESPACE -l app=load-subscribers
          echo ""
          echo "Recent logs:"
          kubectl logs -n $NAMESPACE -l app=load-subscribers --tail=50
          exit 1
        fi
